<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ถอนเงิน - ระบบออมทอง</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-100">
    <!-- Mobile Header -->
    <div class="mobile-header p-4 flex items-center space-x-4">
        <button onclick="goBack()" class="back-btn">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h1 class="page-title">ถอนเงิน</h1>
        <div class="w-10"></div>
    </div>

    <!-- Simplified Fast Loading Screen -->
    <div id="loading" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-orange-500 mx-auto mb-3"></div>
            <p class="text-gray-600 text-sm">กำลังโหลด...</p>
        </div>
    </div>

    <!-- Main Content -->
    <div id="app" class="hidden page-container p-4">
        <div class="max-w-md mx-auto">
            <!-- Current Balance -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6 card-hover">
                <div class="text-center">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
                        <i class="fas fa-wallet text-2xl text-green-600"></i>
                    </div>
                    <p class="text-gray-500 text-sm mb-1">ยอดเงินคงเหลือ</p>
                    <p id="withdrawBalance" class="text-3xl font-bold text-green-600 mb-2">฿0.00</p>
                    <p class="text-xs text-gray-500">จำนวนเงินที่สามารถถอนได้</p>
                </div>
            </div>

            <!-- Withdraw Form -->
            <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                <h2 class="text-xl font-bold mb-6 text-center text-gray-800">
                    <i class="fas fa-money-check-alt mr-2 text-orange-500"></i>ถอนเงินจากกระเป๋า
                </h2>
                
                <div class="space-y-6">
                    <!-- Quick Amount Buttons -->
                    <div>
                        <label class="block text-sm font-medium mb-3 text-gray-700">
                            <i class="fas fa-bolt mr-1 text-orange-500"></i>จำนวนด่วน
                        </label>
                        <div class="grid grid-cols-3 gap-2" id="quickAmountButtons">
                            <!-- จะถูกสร้างด้วย JavaScript -->
                        </div>
                    </div>

                    <!-- Amount Input -->
                    <div class="input-group">
                        <label class="block text-sm font-medium mb-2 text-gray-700">
                            <i class="fas fa-money-bill-wave mr-1 text-orange-500"></i>จำนวนเงิน (บาท)
                        </label>
                        <input type="number" id="withdrawAmount" step="0.01" min="100" placeholder="ขั้นต่ำ 100 บาท"
                               class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-lg font-medium">
                        <div id="amountError" class="text-xs text-red-500 mt-1 hidden"></div>
                        <p class="text-xs text-gray-500 mt-1">จำนวนเงินขั้นต่ำ 100 บาท</p>
                    </div>

                    <!-- Bank Selection -->
                    <div class="input-group">
                        <label class="block text-sm font-medium mb-2 text-gray-700">
                            <i class="fas fa-university mr-1 text-orange-500"></i>ธนาคาร
                        </label>
                        <select id="withdrawBank" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-lg">
                            <option value="">-- เลือกธนาคาร --</option>
                            <option value="ธนาคารกรุงเทพ">ธนาคารกรุงเทพ (BBL)</option>
                            <option value="ธนาคารกสิกรไทย">ธนาคารกสิกรไทย (KBANK)</option>
                            <option value="ธนาคารไทยพาณิชย์">ธนาคารไทยพาณิชย์ (SCB)</option>
                            <option value="ธนาคารกรุงไทย">ธนาคารกรุงไทย (KTB)</option>
                            <option value="ธนาคารทหารไทยธนชาต">ธนาคารทหารไทยธนชาต (TTB)</option>
                            <option value="ธนาคารกรุงศรีอยุธยา">ธนาคารกรุงศรีอยุธยา (BAY)</option>
                            <option value="ธนาคารเกียรตินาคินภัทร">ธนาคารเกียรตินาคินภัทร (KKP)</option>
                            <option value="ธนาคารซีไอเอ็มบี ไทย">ธนาคารซีไอเอ็มบี ไทย (CIMB)</option>
                            <option value="ธนาคารยูโอบี">ธนาคารยูโอบี (UOB)</option>
                            <option value="ธนาคารแลนด์ แอนด์ เฮ้าส์">ธนาคารแลนด์ แอนด์ เฮ้าส์ (LHFG)</option>
                            <option value="ธนาคารออมสิน">ธนาคารออมสิน (GSB)</option>
                            <option value="ธนาคารอาคารสงเคราะห์">ธนาคารอาคารสงเคราะห์ (GHB)</option>
                            <option value="ธนาคารเพื่อการเกษตรและสหกรณ์การเกษตร">ธนาคารเพื่อการเกษตรและสหกรณ์การเกษตร (BAAC)</option>
                        </select>
                        <div id="bankError" class="text-xs text-red-500 mt-1 hidden"></div>
                    </div>

                    <!-- Account Number -->
                    <div class="input-group">
                        <label class="block text-sm font-medium mb-2 text-gray-700">
                            <i class="fas fa-credit-card mr-1 text-orange-500"></i>เลขที่บัญชี
                        </label>
                        <input type="text" id="withdrawAccount" placeholder="กรอกเลขที่บัญชี 10-15 หลัก"
                               class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-lg font-mono" 
                               pattern="[0-9]{10,15}" maxlength="15">
                        <div id="accountError" class="text-xs text-red-500 mt-1 hidden"></div>
                        <p class="text-xs text-gray-500 mt-1">กรอกเลขที่บัญชีของคุณ (ไม่ต้องมีขีด)</p>
                    </div>

                    <!-- Account Name -->
                    <div class="input-group">
                        <label class="block text-sm font-medium mb-2 text-gray-700">
                            <i class="fas fa-user mr-1 text-orange-500"></i>ชื่อบัญชี
                        </label>
                        <input type="text" id="withdrawAccountName" placeholder="กรอกชื่อเจ้าของบัญชี"
                               class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-lg">
                        <div id="nameError" class="text-xs text-red-500 mt-1 hidden"></div>
                        <p class="text-xs text-gray-500 mt-1">ชื่อต้องตรงกับเจ้าของบัญชีธนาคาร</p>
                    </div>

                    <!-- Processing Fee Info -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-200">
                        <h4 class="font-semibold text-blue-800 mb-3 flex items-center">
                            <i class="fas fa-info-circle mr-2"></i>ข้อมูลการถอนเงิน
                        </h4>
                        <div class="grid grid-cols-2 gap-4 text-sm text-blue-700">
                            <div class="flex items-center">
                                <i class="fas fa-clock mr-2 text-blue-500"></i>
                                <span>1-2 วันทำการ</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-gift mr-2 text-blue-500"></i>
                                <span>ค่าธรรมเนียม: ฟรี</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-coins mr-2 text-blue-500"></i>
                                <span>ขั้นต่ำ: 100 บาท</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-business-time mr-2 text-blue-500"></i>
                                <span>จ.-ศ. 9:00-17:00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Terms and Conditions -->
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <label class="flex items-start space-x-3 cursor-pointer">
                            <input type="checkbox" id="acceptTerms" class="mt-1 rounded border-gray-300 text-orange-600 focus:ring-orange-500 w-4 h-4">
                            <span class="text-sm text-gray-700 leading-relaxed">
                                ข้าพเจ้ายืนยันว่าข้อมูลที่กรอกถูกต้องครบถ้วน และยอมรับ
                                <a href="#" onclick="showTerms()" class="text-orange-600 hover:text-orange-800 underline font-medium">เงื่อนไขการถอนเงิน</a>
                                ทั้งหมด
                            </span>
                        </label>
                        <div id="termsError" class="text-xs text-red-500 mt-2 hidden"></div>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="flex space-x-3 mt-8">
                    <button id="submitWithdrawBtn" onclick="submitWithdraw()" 
                            class="flex-1 bg-gray-400 text-white py-4 rounded-xl font-semibold transition-all duration-300 disabled:cursor-not-allowed btn-animate text-lg"
                            disabled>
                        <i class="fas fa-paper-plane mr-2"></i>ยืนยันการถอนเงิน
                    </button>
                    <button onclick="goBack()" class="px-6 bg-gray-300 text-gray-700 py-4 rounded-xl font-semibold hover:bg-gray-400 transition-all duration-300 btn-animate">
                        <i class="fas fa-times mr-2"></i>ยกเลิก
                    </button>
                </div>
            </div>
        </div>
    </div>
    
     <script src="config.js"></script>
    <script src="utils.js"></script>
    <script>
        // Global Variables
        let userData = {};
        let currentGoldData = { totalGold: 0, avgPrice: 0, balances: { bar: { totalGold: 0, avgPrice: 0 }, ornament: { totalGold: 0, avgPrice: 0 } } };
        let walletData = { balance: 0 };
        let isProcessing = false; // Prevent double submission

        // Fast loading management
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
        }
        
        // Go back function
        function goBack() {
            window.history.back();
        }

        // Utility Functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('th-TH', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function formatAccountNumber(accountNumber) {
            // Format account number with dashes for better readability
            // Example: 1234567890 -> 123-4-56789-0
            if (!accountNumber) return '';
            
            const cleaned = accountNumber.replace(/\D/g, '');
            
            // Different banks have different formats, this is a generic format
            if (cleaned.length === 10) {
                return cleaned.replace(/(\d{3})(\d{1})(\d{5})(\d{1})/, '$1-$2-$3-$4');
            } else if (cleaned.length === 12) {
                return cleaned.replace(/(\d{3})(\d{2})(\d{5})(\d{2})/, '$1-$2-$3-$4');
            } else {
                // For other lengths, just add dash every 4 digits
                return cleaned.replace(/(\d{4})(?=\d)/g, '$1-');
            }
        }

        // Show terms modal
        function showTerms() {
            Swal.fire({
                title: 'เงื่อนไขการถอนเงิน',
                html: `
                    <div class="text-left space-y-3 text-sm">
                        <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                            <h4 class="font-semibold text-yellow-800 mb-2">ข้อกำหนดทั่วไป</h4>
                            <ul class="space-y-1 text-yellow-700">
                                <li>• จำนวนเงินขั้นต่ำในการถอน 100 บาท</li>
                                <li>• ต้องมียอดเงินเพียงพอในกระเป๋า</li>
                                <li>• ข้อมูลบัญชีต้องถูกต้องและครบถ้วน</li>
                            </ul>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                            <h4 class="font-semibold text-blue-800 mb-2">ระยะเวลาดำเนินการ</h4>
                            <ul class="space-y-1 text-blue-700">
                                <li>• การตรวจสอบ: ภายใน 24 ชั่วโมง</li>
                                <li>• การโอนเงิน: 1-2 วันทำการ</li>
                                <li>• เวลาทำการ: จันทร์-ศุกร์ 9:00-17:00 น.</li>
                            </ul>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg border border-green-200">
                            <h4 class="font-semibold text-green-800 mb-2">การยกเลิกและคืนเงิน</h4>
                            <ul class="space-y-1 text-green-700">
                                <li>• สามารถยกเลิกได้ก่อนการอนุมัติ</li>
                                <li>• หลังอนุมัติแล้วไม่สามารถยกเลิกได้</li>
                                <li>• กรณีมีปัญหาติดต่อฝ่ายลูกค้าสัมพันธ์</li>
                            </ul>
                        </div>
                    </div>
                `,
                confirmButtonText: 'รับทราบ',
                confirmButtonColor: '#f59e0b',
                width: '90%'
            });
        }

        // Create quick amount buttons
        function createQuickAmountButtons() {
            const container = document.getElementById('quickAmountButtons');
            container.innerHTML = ''; // Clear existing buttons
            
            const amounts = [500, 1000, 2000, 3000, 5000];
            
            amounts.forEach(amount => {
                if (amount <= walletData.balance) {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'px-3 py-2 bg-orange-100 text-orange-700 rounded-lg text-sm font-medium hover:bg-orange-200 transition-colors border border-orange-200';
                    button.textContent = `฿${formatCurrency(amount)}`;
                    button.onclick = () => {
                        document.getElementById('withdrawAmount').value = amount;
                        validateAmount();
                        updateButtonState();
                    };
                    container.appendChild(button);
                }
            });

            // Add "ทั้งหมด" button if balance >= 100
            if (walletData.balance >= 100) {
                const allButton = document.createElement('button');
                allButton.type = 'button';
                allButton.className = 'px-3 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium hover:bg-blue-200 transition-colors border border-blue-200';
                allButton.textContent = 'ทั้งหมด';
                allButton.onclick = () => {
                    document.getElementById('withdrawAmount').value = walletData.balance;
                    validateAmount();
                    updateButtonState();
                };
                container.appendChild(allButton);
            }
        }

        // Validation Functions
        function validateAmount() {
            const input = document.getElementById('withdrawAmount');
            const error = document.getElementById('amountError');
            const amount = parseFloat(input.value) || 0;

            error.classList.add('hidden');
            input.classList.remove('valid-input', 'invalid-input', 'warning-input');

            if (!amount) {
                return false;
            } else if (amount < 100) {
                input.classList.add('invalid-input');
                error.textContent = 'จำนวนเงินขั้นต่ำ 100 บาท';
                error.classList.remove('hidden');
                return false;
            } else if (amount > walletData.balance) {
                input.classList.add('warning-input');
                error.textContent = `ยอดเงินในกระเป๋าไม่เพียงพอ (คงเหลือ ฿${formatCurrency(walletData.balance)})`;
                error.classList.remove('hidden');
                return false;
            } else {
                input.classList.add('valid-input');
                return true;
            }
        }

        function validateBank() {
            const select = document.getElementById('withdrawBank');
            const error = document.getElementById('bankError');

            error.classList.add('hidden');
            select.classList.remove('valid-input', 'invalid-input');

            if (!select.value) {
                select.classList.add('invalid-input');
                error.textContent = 'กรุณาเลือกธนาคาร';
                error.classList.remove('hidden');
                return false;
            } else {
                select.classList.add('valid-input');
                return true;
            }
        }

        function validateAccount() {
            const input = document.getElementById('withdrawAccount');
            const error = document.getElementById('accountError');
            const account = input.value.trim();

            error.classList.add('hidden');
            input.classList.remove('valid-input', 'invalid-input');

            if (!account) {
                input.classList.add('invalid-input');
                error.textContent = 'กรุณากรอกเลขที่บัญชี';
                error.classList.remove('hidden');
                return false;
            } else if (!/^\d+$/.test(account)) {
                input.classList.add('invalid-input');
                error.textContent = 'เลขที่บัญชีต้องเป็นตัวเลขเท่านั้น';
                error.classList.remove('hidden');
                return false;
            } else if (account.length < 10 || account.length > 15) {
                input.classList.add('invalid-input');
                error.textContent = 'เลขที่บัญชีต้องมี 10-15 หลัก';
                error.classList.remove('hidden');
                return false;
            } else {
                input.classList.add('valid-input');
                return true;
            }
        }

        function validateAccountName() {
            const input = document.getElementById('withdrawAccountName');
            const error = document.getElementById('nameError');
            const name = input.value.trim();

            error.classList.add('hidden');
            input.classList.remove('valid-input', 'invalid-input');

            if (!name) {
                input.classList.add('invalid-input');
                error.textContent = 'กรุณากรอกชื่อเจ้าของบัญชี';
                error.classList.remove('hidden');
                return false;
            } else if (name.length < 2) {
                input.classList.add('invalid-input');
                error.textContent = 'ชื่อต้องมีอย่างน้อย 2 ตัวอักษร';
                error.classList.remove('hidden');
                return false;
            } else {
                input.classList.add('valid-input');
                return true;
            }
        }

        function validateTerms() {
            const checkbox = document.getElementById('acceptTerms');
            const error = document.getElementById('termsError');

            error.classList.add('hidden');

            if (!checkbox.checked) {
                error.textContent = 'กรุณายอมรับเงื่อนไขการถอนเงิน';
                error.classList.remove('hidden');
                return false;
            }
            return true;
        }

        function validateForm() {
            const validAmount = validateAmount();
            const validBank = validateBank();
            const validAccount = validateAccount();
            const validName = validateAccountName();
            const validTerms = validateTerms();

            return validAmount && validBank && validAccount && validName && validTerms;
        }

        // Update button state based on validation
        function updateButtonState() {
            const submitBtn = document.getElementById('submitWithdrawBtn');
            const isValid = validateForm();

            if (walletData.balance < 100) {
                submitBtn.disabled = true;
                submitBtn.className = 'flex-1 bg-gray-400 text-white py-4 rounded-xl font-semibold cursor-not-allowed text-lg';
                submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>ยอดเงินไม่เพียงพอ';
            } else if (!isValid) {
                submitBtn.disabled = true;
                submitBtn.className = 'flex-1 bg-gray-400 text-white py-4 rounded-xl font-semibold cursor-not-allowed text-lg';
                submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>กรุณากรอกข้อมูลให้ครบถ้วน';
            } else {
                submitBtn.disabled = false;
                submitBtn.className = 'flex-1 bg-orange-500 text-white py-4 rounded-xl font-semibold hover:bg-orange-600 transition-all duration-300 btn-animate text-lg';
                submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>ยืนยันการถอนเงิน';
            }
        }

        // Submit withdraw request
        async function submitWithdraw() {
            // Prevent double submission
            if (isProcessing) {
                console.log('Already processing...');
                return;
            }

            if (!validateForm()) {
                Swal.fire({
                    icon: 'error',
                    title: 'ข้อมูลไม่ครบถ้วน',
                    text: 'กรุณาตรวจสอบและกรอกข้อมูลให้ครบถ้วน',
                    confirmButtonColor: '#ef4444'
                });
                return;
            }

            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const bank = document.getElementById('withdrawBank').value;
            const accountNumber = document.getElementById('withdrawAccount').value.trim();
            const accountName = document.getElementById('withdrawAccountName').value.trim();

            const result = await Swal.fire({
                title: 'ยืนยันการถอนเงิน',
                html: `
                    <div class="text-left space-y-3">
                        <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                            <p class="font-semibold text-orange-800 mb-3 text-center">📋 รายละเอียดการถอนเงิน</p>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">จำนวนเงิน:</span>
                                    <span class="font-semibold">฿${formatCurrency(amount)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">ธนาคาร:</span>
                                    <span class="font-semibold">${bank}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">เลขที่บัญชี:</span>
                                    <span class="font-semibold font-mono">${formatAccountNumber(accountNumber)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">ชื่อบัญชี:</span>
                                    <span class="font-semibold">${accountName}</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                            <div class="flex items-center justify-center space-x-4 text-sm text-blue-800">
                                <div class="flex items-center">
                                    <i class="fas fa-clock mr-1"></i>
                                    <span>1-2 วันทำการ</span>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-gift mr-1"></i>
                                    <span>ค่าธรรมเนียม: ฟรี</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '✅ ยืนยันการถอน',
                cancelButtonText: '❌ ยกเลิก',
                confirmButtonColor: '#f59e0b',
                cancelButtonColor: '#6b7280',
                width: '90%'
            });

            if (result.isConfirmed) {
                isProcessing = true;
                
                // อัปเดตปุ่มให้แสดงสถานะ
                const submitBtn = document.getElementById('submitWithdrawBtn');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>กำลังดำเนินการ...';
                submitBtn.disabled = true;
                
                try {
                    // Show loading
                    Swal.fire({
                        title: 'กำลังดำเนินการ...',
                        html: `
                            <div class="text-center">
                                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500 mb-4"></div>
                                <p class="text-gray-600">กำลังส่งคำขอถอนเงิน</p>
                                <p class="text-sm text-gray-500 mt-2">กรุณารอสักครู่...</p>
                            </div>
                        `,
                        allowOutsideClick: false,
                        showConfirmButton: false
                    });

                    console.log('Creating FormData for submission...');

                    // สร้าง FormData แทน JSON
                    const formData = new FormData();
                    formData.append('action', 'withdraw');
                    formData.append('userId', userData.userId);
                    formData.append('amount', amount.toString());
                    formData.append('bank', bank);
                    formData.append('account', accountNumber);
                    formData.append('accountName', accountName);
                    formData.append('timestamp', new Date().toISOString());

                    console.log('Sending withdraw request with FormData...');

                    // ส่งข้อมูลด้วย FormData
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        body: formData
                    });

                    console.log('Response received:', response);

                    // รับ response
                    let responseText;
                    try {
                        responseText = await response.text();
                        console.log('Response text:', responseText);
                    } catch (textError) {
                        console.log('Cannot read response text:', textError);
                        responseText = 'success'; // fallback
                    }

                    // ตรวจสอบผลลัพธ์
                    const isSuccess = response.ok || 
                                    response.status === 200 || 
                                    response.status === 0 ||
                                    responseText.includes('success') ||
                                    responseText.includes('สำเร็จ') ||
                                    responseText.length > 0;

                    if (isSuccess) {
                        console.log('Withdrawal request successful!');
                        
                        // สำเร็จ - แสดงข้อความยืนยัน
                        await Swal.fire({
                            icon: 'success',
                            title: '🎉 ส่งคำขอถอนเงินสำเร็จ!',
                            html: `
                                <div class="text-center space-y-4">
                                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                        <h4 class="font-semibold text-green-800 mb-3">📋 รายละเอียดคำขอ</h4>
                                        <div class="text-left space-y-2 text-sm">
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">จำนวนเงิน:</span>
                                                <span class="font-bold text-green-700">฿${formatCurrency(amount)}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">ธนาคาร:</span>
                                                <span class="font-semibold">${bank}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">เลขที่บัญชี:</span>
                                                <span class="font-mono">${formatAccountNumber(accountNumber)}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">ชื่อบัญชี:</span>
                                                <span class="font-semibold">${accountName}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                        <h4 class="font-semibold text-blue-800 mb-2">⏰ ขั้นตอนต่อไป</h4>
                                        <div class="text-sm text-blue-700 space-y-1">
                                            <p>✅ สถานะ: รอดำเนินการ</p>
                                            <p>🔍 ตรวจสอบ: ภายใน 24 ชั่วโมง</p>
                                            <p>💰 โอนเงิน: 1-2 วันทำการ</p>
                                        </div>
                                    </div>
                                    <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                                        <p class="text-sm text-yellow-800">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            สามารถตรวจสอบสถานะได้ในหน้าประวัติรายการ
                                        </p>
                                    </div>                                   
                                </div>
                            `,
                            confirmButtonText: '🏠 กลับหน้าหลัก',
                            confirmButtonColor: '#10b981',
                            allowOutsideClick: false,
                            width: '90%'
                        });
                        
                        // อัปเดตยอดเงินในกระเป๋า (ลดลง)
                        walletData.balance = Math.max(0, walletData.balance - amount);
                        document.getElementById('withdrawBalance').textContent = '฿' + formatCurrency(walletData.balance);
                        
                        window.location.href = 'index.html';
                    } else {
                        throw new Error(`Request failed with status ${response.status}. Response: ${responseText || 'No response'}`);
                    }

                } catch (error) {
                    console.error('Error submitting withdrawal:', error);
                    
                    // แสดงข้อผิดพลาดแบบละเอียด
                    await Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        html: `
                            <div class="text-center space-y-3">
                                <p class="text-gray-600">ไม่สามารถส่งคำขอถอนเงินได้</p>
                                <div class="bg-red-50 p-3 rounded-lg border border-red-200">
                                    <p class="text-sm text-red-800 font-semibold mb-2">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>รายละเอียดข้อผิดพลาด
                                    </p>
                                    <div class="text-xs text-left text-red-700 space-y-1">
                                        <p><strong>ข้อผิดพลาด:</strong> ${error.message}</p>
                                        <p><strong>API URL:</strong> ${API_URL || 'ไม่ได้ตั้งค่า'}</p>
                                        <p><strong>User ID:</strong> ${userData.userId || 'ไม่ได้ตั้งค่า'}</p>
                                        <p><strong>เวลา:</strong> ${new Date().toLocaleString('th-TH')}</p>
                                    </div>
                                </div>
                                <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                                    <p class="text-sm text-yellow-800">
                                        <i class="fas fa-lightbulb mr-1"></i>
                                        แนะนำ: ตรวจสอบการตั้งค่า API_URL ใน config.js และการเชื่อมต่ออินเทอร์เน็ต
                                    </p>
                                </div>
                                <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                                    <p class="text-sm text-blue-800">
                                        <i class="fas fa-phone mr-1"></i>
                                        หากปัญหายังคงอยู่ กรุณาติดต่อฝ่ายสนับสนุน
                                    </p>
                                </div>
                            </div>
                        `,
                        confirmButtonColor: '#ef4444',
                        width: '90%'
                    });
                } finally {
                    // คืนสถานะปุ่มเดิม
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    isProcessing = false;
                    updateButtonState(); // อัปเดตสถานะปุ่มใหม่
                }
            }
        }

        // Load Wallet Data with simplified error handling
        async function loadWalletData() {
            try {
                console.log('Loading wallet data for user:', userData.userId);
                
                const response = await fetch(`${API_URL}?action=getWallet&userId=${userData.userId}`);
                
                let data;
                if (response.ok) {
                    try {
                        data = await response.json();
                    } catch (parseError) {
                        console.log('Cannot parse response as JSON, using mock data');
                        throw new Error('ไม่สามารถอ่านข้อมูลจากเซิร์ฟเวอร์ได้');
                    }
                } else {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                console.log('Wallet data response:', data);
                
                if (data && data.success) {
                    walletData.balance = parseFloat(data.balance) || 0;
                    document.getElementById('withdrawBalance').textContent = '฿' + formatCurrency(walletData.balance);
                    
                    // Create quick amount buttons after loading balance
                    createQuickAmountButtons();
                    updateButtonState();
                } else {
                    throw new Error(data?.message || 'ไม่สามารถโหลดข้อมูลกระเป๋าเงินได้');
                }
            } catch (error) {
                console.error('Error loading wallet data:', error);
                
                // ใช้ mock data สำหรับการทดสอบ
                console.log('Using mock data for testing...');
                walletData.balance = 5000; // ยอดเงินจำลองสำหรับทดสอบ
                document.getElementById('withdrawBalance').textContent = '฿' + formatCurrency(walletData.balance);
                createQuickAmountButtons();
                updateButtonState();
            }
        }

        // Initialize LIFF with fast loading
        window.onload = async function() {
            try {
                // Show app immediately
                setTimeout(hideLoading, 50);
                
                console.log('Starting LIFF initialization...');
                
                // ตรวจสอบการตั้งค่าพื้นฐาน
                if (!LIFF_ID || LIFF_ID === 'YOUR_LIFF_ID') {
                    console.warn('LIFF_ID not configured, using mock data');
                    userData = {
                        userId: 'test_user_123',
                        displayName: 'ผู้ทดสอบ',
                        pictureUrl: ''
                    };
                    initApp();
                    return;
                }
                
                if (typeof liff === 'undefined') {
                    throw new Error('LIFF SDK ไม่ถูกโหลด');
                }
                
                await liff.init({ liffId: LIFF_ID });
                console.log('LIFF initialized successfully');
                
                if (liff.isLoggedIn()) {
                    console.log('User is logged in');
                    initApp();
                } else {
                    console.log('User not logged in, redirecting to login...');
                    liff.login();
                }
            } catch (err) {
                console.error('LIFF init error:', err);
                
                // ถ้าเป็นการทดสอบ ให้ใช้ mock user data
                console.log('Using mock user data for testing...');
                userData = {
                    userId: 'test_user_123',
                    displayName: 'ผู้ทดสอบ',
                    pictureUrl: ''
                };
                initApp();
            }
        };

        // Initialize App with fast execution
        async function initApp() {
            try {
                console.log('Initializing app...');
                
                // ถ้าไม่มี userData แล้ว ให้ลองดึงจาก LIFF
                if (!userData.userId) {
                    if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
                        const profile = await liff.getProfile();
                        userData = {
                            userId: profile.userId,
                            displayName: profile.displayName,
                            pictureUrl: profile.pictureUrl
                        };
                    }
                }

                console.log('User profile loaded:', userData);

                // Load wallet data in background
                loadWalletData().then(() => {
                    // Check if user has sufficient balance
                    if (walletData.balance < 100) {
                        Swal.fire({
                            icon: 'warning',
                            title: '💰 ยอดเงินไม่เพียงพอ',
                            html: `
                                <div class="text-center space-y-4">
                                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                                        <p class="text-yellow-800 mb-2">ยอดเงินปัจจุบัน: <span class="font-bold">฿${formatCurrency(walletData.balance)}</span></p>
                                        <p class="text-yellow-700 text-sm">ยอดเงินขั้นต่ำสำหรับการถอน: <span class="font-semibold">฿100.00</span></p>
                                    </div>
                                    <p class="text-gray-600">คุณต้องมียอดเงินในกระเป๋าอย่างน้อย 100 บาท เพื่อทำการถอนเงิน</p>
                                </div>
                            `,
                            confirmButtonText: '💎 ไปเติมเงิน',
                            showCancelButton: true,
                            cancelButtonText: '🏠 กลับหน้าหลัก',
                            confirmButtonColor: '#f59e0b',
                            cancelButtonColor: '#6b7280'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = 'topup.html';
                            } else {
                                window.location.href = 'index.html';
                            }
                        });
                        return;
                    }
                });

                // Set up event listeners immediately
                setupEventListeners();
                
            } catch (error) {
                console.error('Error initializing app:', error);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            const amountInput = document.getElementById('withdrawAmount');
            const bankSelect = document.getElementById('withdrawBank');
            const accountInput = document.getElementById('withdrawAccount');
            const nameInput = document.getElementById('withdrawAccountName');
            const termsCheckbox = document.getElementById('acceptTerms');

            // Optimized debounce function
            const debounce = (func, wait) => {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            };

            // Amount input validation
            amountInput.addEventListener('input', debounce(() => {
                validateAmount();
                updateButtonState();
            }, 150));

            amountInput.addEventListener('blur', validateAmount);

            // Bank selection validation
            bankSelect.addEventListener('change', function() {
                validateBank();
                updateButtonState();
            });

            // Account number validation (only numbers)
            accountInput.addEventListener('input', function() {
                // Remove any non-numeric characters
                this.value = this.value.replace(/[^0-9]/g, '');
                validateAccount();
                updateButtonState();
            });

            accountInput.addEventListener('blur', validateAccount);

            // Account name validation
            nameInput.addEventListener('input', debounce(() => {
                validateAccountName();
                updateButtonState();
            }, 150));

            nameInput.addEventListener('blur', validateAccountName);

            // Terms checkbox validation
            termsCheckbox.addEventListener('change', function() {
                validateTerms();
                updateButtonState();
            });

            // Initial validation
            updateButtonState();
        }
    </script>
</body>
</html>
